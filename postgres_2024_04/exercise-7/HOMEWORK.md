#  Кластер Patroni on-premise 2

## Настройка YC CLI и создание ВМ

### 1. Выполняю базовую настройку облака в CLI
![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/5e550663-e693-4f41-9aad-e68a7ebd13ab)

### 2. Настраиваю виртуальную инфраструктуру для ВМ

**2.1. Создаю сеть**

**2.2. Создаю подсеть и задаю ей пул**

**2.3. Создаю зону DNS**

**2.4. Проверяю данные инфраструктуры**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/fa24ea01-0a3b-43b9-b7b7-e379ac66b26c)

### 3. Создаю инфраструктуру из ВМ:

**3.1. для etcd:**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/d7a23d8a-6e24-4534-87c8-af92c7df63ac)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/00def683-8621-4fb6-88f4-44e0860e16a5)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/25bf5f4d-b415-4f0a-bb77-20623d572ec0)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/e074fd0b-970f-4fca-a2ea-30d7b8a6107a)

**3.2. для Postgres + Patroni:**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/b72ec727-5d2e-479c-8a6f-21d734ceb0d7)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/2710d717-7fc4-4fe6-b9a7-2107dba0abc7)

**3.3. для HAProxy:**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/b1e61f97-0ad5-4d96-ba2c-c5f373c6c8e2)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/315bd857-9d7c-4a43-96ab-ad538718a28d)

## Настройки будут производиться на примере одной ВМ (аналогичные действия буду производиться на всех членах кластера ВМ того же типа)

## Настраиваю ETCD

### 4. Подключаюсь к ВМ и устанавливаю ECTD с помощью заранее подготовленного скрипта
Для установки использую скрипт из [официального репозитория](https://github.com/etcd-io/etcd) на GitHub, который немного видоизменен для упрощения установки.
Запускаю от root, чтобы точно не было проблем с доступами.
Действия выполняю на всех серверах ETCD.
**Создаю скрипт**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/370dbd17-0c21-466e-ba4c-b603a3dfc6ed)

**Запускаю (в скрипт входит и проверка утилит, входящих в состав ETCD)**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/d3f1f4f1-a1bc-4079-9bd0-100fe4bc7ac2)

### 5. Настраиваю конфигурационные файлы
**Привожу пример конфигурации (*/etc/default/etcd.yml*) на одной из нод:**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/d3ba8c2c-356d-4739-bb92-7b94cd722ef4)

**Также создаю systemd-юнит:**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/66641178-54f8-4880-af32-7430e83f4175)

**5.1. Добавляю сервис в автозапуск, запускаю его и проверяю статус**

**5.2. Проверяю статус кластера (вроде бы все ОК, кластер в порядке)**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/4b8d1e99-cb95-463c-8f0f-f05f6a5c9cc2)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/10270373-fb65-4a9a-b3f2-d77114f8024d)

**5.3. Меняю initial-cluster-state на *existing***

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/358fecec-9bbf-410d-afdd-18ec4fd7e761)

## Подготавливаю Postgres

### 6\. Установил Postgres 15 по [документации](https://www.postgresql.org/download/linux/ubuntu/)
**Проверяю статус установки**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/8c049691-e4a6-4dba-bf7c-71bf9df10634)

**Выключаю сервис Postgres и удаляю из автозапуска, чтобы полностью передать его под управление Patroni**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/c9a39712-5dc7-47e7-952d-9c41437d4c19)

## Подготавливаю Patroni

### 7\. Устанавливаю Patroni

**7.1. Установил пакеты *python3* и *pip***

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/a5170083-d511-44ba-8f9a-c0793fab662c)

**7.2. Установил Python-модули *python-etcd* и *psycopg***

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/5ae0b4b0-4783-4a04-a567-55d10bf0346e)

**7.3. Проверил статус установки**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/63c01aae-6fb2-4345-a76a-0a6c042abf1d)

### 8\. Выполняю подготовительные действия перед настройкой

**8.1. Делаю копию каталога с данными по умолчанию и создаю новый**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/2be54c82-6d56-4e09-9ed0-e74fa5ffe790)

**8.2. Создаю каталог файла конфигурации и делаю пользователя *postgres* его владельцем**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/16dcf98a-8fde-4009-8c85-92c51b065ea1)

### 9\. Конфигурирую Patroni

**9.1. Создаю файл конфигурации Patroni**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/c762f48a-1e0e-4eb0-b96c-cb68cd291919)

**Содержимое файла:**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/968951f8-3c65-4dad-9100-bc452d7740da)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/9fcec712-96ce-43da-91a1-9b6e584af60a)

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/9da95326-4cae-4326-b172-499b6977c9c4)

**9.2. Создаю systemd-юнит (цифра 7 на скриншоте - явно лишняя)**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/67e11128-b1f2-4e06-be04-e35e31c1fc09)

**9.3. Провожу тестовый запуск и проверяю статус**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/59583122-df07-40d7-b477-2bf9bab5a7ce)

**9.3.1. Пробую узнать состояние кластера со стороны Patroni. Но тут явно что-то идет не так**

**9.3.2. Пробую установить модуль, без которого Patroni не может жить**

**9.3.3. Проверяю еще раз**

**На этот раз показал что-то похожее на рабочий кластер**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/ba86afb4-18cb-4011-bec0-581ee1958a43)

**9.4. Убеждаюсь, что реплика работает как нужно (на этот раз - 9 лишняя)**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/9d963785-7e05-457d-9608-2938b6af7299)

**9.5. Радуюсь**

## Подготавливаю PGBouncer

### 10\. Устанавливаю PGBouncer на всех серверах с Postgres и Patroni

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/7cbf4f77-df5a-49e9-b26d-b2d6e9881977)

### 11\. Проверяю статус сервиса

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/5a866089-85ad-4fc5-8a68-4131fed2a3ba)

### 12\. Конфигурирую сервис

Добавляю в конец файла конфигурации */etc/pgbouncer/pgbouncer.ini* пользовательские параметры:

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/0ab6e6c1-7599-4ffe-8319-6c381ba41a85)

Создаю файл конфигурации */etc/pgbouncer/userlist.txti*, добавляю туда данные пользователя, под которым планирую подключаться:

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/f91b11f4-2729-4c12-895b-815aabcb17f5)

**12.1. Проверяю кто сейчас является мастером**

**12.2. Перезапускаю сервис, чтобы закрепить настройки**

**12.3. Создаю тестовую БД, указанную в настройках PGBouncer**

**12.4. Выполняю тестовое подключение**

**12.5. Радуюсь**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/a1974020-5f2a-41b3-a8c1-d5e490d6b6b2)

## Подготавливаю HAProxy

### 13\. Устанавливаю HAProxy на двух заранее подготовленных серверах

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/d761aa08-2753-40fb-8b65-90d5dffac435)

### 14\. Конфигурирую и запускаю сервис

**14.1. Меняю конфиг */etc/haproxy/haproxy.cfg***

**14.2. Добавляю коннекторы для подключения к PG Boucer'у**

**14.3. Перезапускаю сервис чтобы применить изменения**

**14.4. Проверяю статус сервиса**

**14.5. Вижу, что недоступны 1 и 3 ноды, пробую узнать как дела у 2 - он мастер. Отлично!**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/3c1da36e-2df5-48da-b633-a71eb994713b)

**14.6. Пробую подключиться к одной из нод PG Bouncer с сервера HAProxy, успешно**

**14.7. Пробую подключиться к PG Bouncer ЧЕРЕЗ HAProxy**

**14.8. Понимаю что что-то настроено неверно**

**14.9. Правлю конифиг и добавляю в listener опцию для TCP-соединения** 

**14.10. Подключение успешно** 

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/27d39a1e-2025-4b2d-bb43-2a4dcff1fa6f)

## ВНИМАНИЕ! СПАСИБО ЗА ВНИМАНИЕ!
