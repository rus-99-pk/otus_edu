# PostgreSQL и VKcloud

### 1. Выполняю установку Terraform по [документации](https://developer.hashicorp.com/terraform/install)

**1.1. Добавляю репозиторий. Понимаю, что без VPN сделать это не удастся**  

**1.2. Подключаю VPN и пробую еще раз. УРА, репозиторий есть**  

**1.3. Устанавливаю Terraform**  

**1.4. Проверяю статус установки**  
![cfe403961e9cea90df77cc83ac94d2b3.png](:/9576d468028f48b897bc4842a166d372)

![cd4352b2c7ff75d4d60c82c310bd94e8.png](:/2ff2f6508e7e490facbe52d79b7b8ac6)
* * *
## Выполняю деплой ВМ с помощью Terraform в VK Cloud

### 2. Подготовливаю каталоги под инфраструктуру TF

![9fe0fb836bdd43764be8ce24a9249384.png](:/1eaa606a5b8848a9970d794f4dc4b1be)

### 3. Активирую работу сервисов, привязав карту

### 4. Выполняю подготовительные шаги ([документация](https://cloud.vk.com/docs/tools-for-using-services/terraform/quick-start#965-tabpanel-1))

**4.1. Включаю 2FA и Доступ по API**

![1f01f3aa99c8a0923d1e869fbb7c8af4.png](:/acc6f85222d646de946f13a98263b2c5)

**4.2. На главной странице иду в настройки проекта**

![0857507641de34868db4670a022cdc02.png](:/3d282ca5e0da4cf28c5d2e3a6c6e92b8)

**4.3. Иду по вкладку Terraform и качаю оттуда файлы конфигурации Terraform и зеркала Terraform**

![aa1429d045ce4334e8f3d45562c3c88b.png](:/6d532362d5904f23aad10777924285d0)

**4.4. Иду в каталог с созданным проектом и раскидываю необходимые файлы**

![a1bc3b961e2f147af84b02165e6fe7eb.png](:/63d66b4714d145bfa6f83d8da6c6fae5)

### 5. Выполняю инициализацию Terraform

![2801f06dde28a31beda520f61fac5eed.png](:/c6588f108caf498f8f75695d671cf707)

### 6. Создаю инфраструктуру под ВМ ([документация](https://cloud.vk.com/docs/tools-for-using-services/terraform/how-to-guides/iaas/create))

**6.1. Устанавливаю OpenStack по [документации](https://cloud.vk.com/docs/tools-for-using-services/cli/openstack-cli#154-tabpanel-1)**

Осознаю, что  с добавлением рапозитория не работает, поэтому иду в DNF.

![575ffc9076c841fae510a1b0ecc97e91.png](:/394bc3aa68a7474e8fd4f9205e7e5a9b)

![aec798ef606835da3b594145ea40290b.png](:/862577c4742744089ccea560b11d1659)

**6.2. Прохожу аутентификацию в проекте по [документации](https://cloud.vk.com/docs/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu)**

**6.2.1 Иду в настройки проекта -> Доступ по API -> скачиваю сформированный VK Cloud файл *otus-test-openrc.sh***

**6.2.2. Выполняю экспорт переменных окружения**

![e22d9704e79cf400ae839be874238abf.png](:/1861cdc3b1b8478a84ac04104cc2af28)

**6.2.3. Првоеряю версию OpenStack и делаю тестовый запрос**

![a21f8523bb247dd08949b421044882bf.png](:/ac33b9766aed436d9d27ff28d12e56c2)

**6.2.4. Радуюсь**

**6.3. Предварительно выбрав то что мне нужно, задаю это в конфигурации с переменными**

![b6a11cbe53f838c98f90aa68871602a3.png](:/9bc53efc61224245b8de3d3499851525)

![23c2fa319a7b3bf8cc2748556414dff9.png](:/6514040d1bee42c19cea9ace6ae88072)

**6.3.1. Создав ключевую пару**

![cd16e5a880449eeab1d1502c6db5593b.png](:/2b93b3be6a8a4c49b3f5336633b5846b)

![647818275ce114d02dd29acb33a48ab6.png](:/0d327867e3fd4a10bfab38519b4d7284)

В этом файле объявляются следующие переменные:

- **image_name**: имя образа виртуальной машины;
- **compute_flavor**: имя шаблона конфигурации виртуальной машины;
- **key_pair_name**: имя ключевой пары, которая будет использоваться для подключения к виртуальной машине по SSH;
- **availability_zone_name**: имя зоны доступности, где будет размещена виртуальная машина.

**6.4. Задаю пароль в ранее скачанном файле vkcs_provider.tf**

![c890f70e3437336fd019945c640713b2.png](:/8b577b00675045f98c63294f4093f565)

**6.5. Проверяю лимиты не ресурсы**

![009a3ab3eed7a5219a463ad59c9ffa72.png](:/8c6906955f404b2a83d19b20c7341794)

**6.6. Создаю сетевую инфраструктуру по [документации](https://cloud.vk.com/docs/tools-for-using-services/terraform/how-to-guides/vnet/network#2233-tabpanel-1)**

![82749bff20b919e31fedb4ac6c1b7236.png](:/ccca5ab404b845e187c101a8dc0078d8)

**6.6.1. Проверяю корректность конфигурационных файлов**

Судя по выводу, все прошло успешно.

![66e117d344f9506fed0266be38a4083a.png](:/51d4b599f8974920a80528c0996e8912)

**6.6.2. Пробую применить созданную конфигурацию**

![a53b08f66489551eaa6ab07bc6221c89.png](:/2492fc4946374ff285dbe13b0c45c421)

![4ff2e0a941823425b95531785ffbc834.png](:/cea9a1a7c6a343fa93c676fe07143b8e)

В интерфейсе нашел созданные сети, отлично!

![d5cabedfdbf96b53df804d60d5ea2cdb.png](:/b364d81952aa4401b3bbe2c20ba47282)

**6.7. Создаю файл с описанием ВМ**

![0e01236b1ad207bc71bb5b9fb9bea1a9.png](:/2dd62adebc7f458bb118645b9c88f416)

**6.8. Создаю ресурсы с помощью Terraform**

**6.8.1. Проверяю наличие необходимых для инфраструктуры файлов**  

**6.8.2. Инициализирую ресурсы. Успешно!**  

**6.8.3. Применяю ресурсы**  

![aab1b31d6277ae4cf2e65abdb8b2652d.png](:/be647a0f6b604b959d8552611b88bd5a)

**И... Terraform ругается на неописанные ресурсы.**

**Разбор исключений и их исправление опишу VVV**

### 7. Исправляю исключения

![759e5e050e0d080841de175cca88584c.png](:/ed75f96709f249a6b3faf3f0a94d06a8)

**7.1. Исключение выше попробовал исправить, изменив все вхождения *vkcs_networking_network.network* на *vkcs_networking_network.example***

![180845e7204cec749fdb9798a0ff5aeb.png](:/35c350c27ec045daa4ee0b58dcad6c30)

**7.2. Словил еще одно исключение, кчажется связано с группой безопасности**

![712c9077cdfe1177a14e13f3a18c134e.png](:/7226165101ce495a8e77d63018d1b7b1)

**Для его решения:**

**7.2.1. Создал файл *secgroup.tf* с группой безопасности (лишним не будет)**  

**7.2.2. Изменил в *main.tf* значение переменной *security_group* с *\["default","ssh"\]***  

**7.2.3. На *\["default"\]***

![7f9cc88050fa4d9b66f0155df990bc79.png](:/dbbe77bd83f74b07add24a030f2aefc3)

**7.3. И еще одно исключение. На этот раз, полагаю, из-за размера блочного устройства**

**7.3.1. Изменил в *main.tf* значение переменной *volume_size* с 8 до 25 (судя по ошибке, значение указывается в ГБ)**

![f83b93ee5c982c87793a69a58019c61e.png](:/91a901c963a048a998c389f31683cf1f)

**7.4. Повторная попытка запуска**

**После исправления пробую запусктить *terraform apply* снова.**

**Создается уже 2 минуты...**

![951c7109c07a70c67dbd9b23ecc15f79.png](:/fcdbc36c91a0483fae053547c6198497)

**3 с половиной минуты... начинаю волноваться, что соединение отвалится по таймауту...**

![affda80980555eac2a791987417baa97.png](:/1e0b49bdf73e4ca8b29c142db9b379cd)

**Но нет, все круто!**

![12e4c1170f98d4caa197193d81afe96e.png](:/81be120c6fb24dccb86bc0c72f407a4e)

**Даже в GUI есть:**

![574be6c416f3c28477cb2a9355337150.png](:/c7c18a3ccd3448128d9fb2c21ef27aa5)

**Но теперь новая проблема, нет сетевого доступа:**

![c36d9a35ec3aea050a073745ad4dcc48.png](:/a178ba8036ce4555b111dd05107069fd)

**По настройкам будто бы так и должно быть...**

![778a694d968ec8b84deece5a63684b91.png](:/f5f8216ed4574a7dad5e1ad22e156b6b)

**После изучения задачи, понимаю, что моя ошибка была на шаге 6.9.2.3. Иду исправлять**

**7.4.1. Меняю имя группы безопасности в *secgroup.tf***

**7.4.2. Прописываю его в список групп безопасности *main.tf***

**7.4.3. Получаю внешний IP еще раз и пробую зайти**

![ec26d129457714b3547932f12851276e.png](:/72d7217dbeb94ec7a1adb3a02108276b)

**Каеф!**
* * *
## Выполняю деплой ВМ с помощью GUI в Sber и Yandex Cloud
* * *
## Sber Cloud

### 8. Создаю ВМ

**8.1. Иду в консоль и нажимаю *Создать ресурс***

**8.2. *Виртуальная машина***

![de7ee22bd6ce4803165a74f8dffb204c.png](:/d2692b6665cd4c71ad79c8c21de48492)

**8.3. Задаю в полях аналогичные VK Cloud настройки и жму *Продолжить***

**8.4. В процессе понимаю, что необходимо создать объект *Публичный ключ***

![5746ecdf87819fd3642fdcaa6650cba9.png](:/2c1f1d4ed29643289fa09fe7d2030b52)

**8.5. После указания нужных мне, например как *Публичный IP* полей жму *Создать***

**8.6. Наблюдаю, что ВМ создается**

![4780f69fc5c9906de98a0d1242b5ffdc.png](:/02c3fc2ade774869927be368bfe0a712)

### 9. Пробую подключиться

**9.1. Снова сетевая недоступность** 

![fa962982bc8323f53321efa13470a83b.png](:/4f4c3c234fe243029925fc474078b40c)

Но на этот раз есть некая группа безопасности по умолчанию, разрешающая SSH. Выглядит еще интереснее чем с VK Cloud...

![dcb87d588d06fb19d3d0d526428f1295.png](:/0029f35135434b91a067b8554badecb9)

**Итог:** после обращения в поддержку и перезапуска ВМ, проблема решилась

**9.2. Дополнительно создал группу для доступа к PG извне**

**9.2.1 Иду в *Виртуальные машины* -> *otus-test-vm* -> листаю в самый низ -> в разделе *Интерфейсы* кликаю на "*...*" -> *Изменить группы безопасности* -> *Создать группу***

**9.2.2. Задаю правила:**

![7bbee946f53f2c8a952f033bf95e6c71.png](:/592904e0814a4f8eba61f74d51573ddc)

**9.2.3. Выбираю новое правило в *Редактирование групп безопасности* и жму *Сохранить***

![2970fa8513be4ca7941f3f48c3da74e1.png](:/3111c62189b841ce8e74b9202f311c67)
* * *
## Yandex Cloud

### 10. Создаю ВМ

**10.1. Иду в консоль и нажимаю *Создать ресурс***

**10.2. *Виртуальная машина***

![503b58ac6bc5b6ae4dbe0ecf4d866371.png](:/593eee9c9566439b8c61b20a7e4f486d)

**10.3. Задаю в полях аналогичные VK и Sber Cloud настройки

**10.4. Создаю сеть**

![6d105914f78fb0a689dc581312559c3d.png](:/8e36ec1c51cc4878bb3ca0f221c27621)

**10.5. Передаю SSH-ключ**

![dadc44f8611325479f6845414ad5d863.png](:/76d7df88a9ed4aea857f04adaae182a6)

**10.6. И наконец, жму *Создать ВМ***

### 11. Пробую подключиться

![6fcd368b7bf600216acefd18eb4cef26.png](:/2494db04c4214076a0bed9eeb7e7bfe3)
* * *
## Деплой PG на ВМ с помощью Ansible

### 12. Создаю каталог с Ansible-проектом и перехожу в него

![ff272e84ce1754bf8ae693a5523729d2.png](:/754c7691be03445588c22ddf6626d656)

### 13. Устанавливаю Ansible

![ecefcfda6eb672e75828965b59a0d34f.png](:/2d7a9e9fce5d46ca909b74e5ed826270)

### 14. Создаю конфигурацию Ansible

**Из важного:**

**14.1. Расположение inventory и remote_tmp**

**14.2. Alias'ы хостов и данные для SSH-подключения**

**14.3. Используемые хосты и роли**

**14.4. Роль locale. Устанавливает RU-локаль по умолчанию**

**14.5. Роль postgres. Устанавливает Postgres, задает параметры в postgresql.conf, устанваливает расширение pg_stat_statements и в случае изменения параметров перезапускает/речитывает конфиг Postgres**

![1a1c9997112967184c1f893b72d0c04c.png](:/3ee19bc149b4463c8ff0c62511903774)

### 15. Собираю хосты ВМ

**15.1. VK Cloud**

![8d9d8f958f14f19a2b809870b5d6acc6.png](:/95fe71c7668a4fddba642cb320d32388)

**15.2. Sber Cloud**

![01f77fa499f43ffaf188e31bd272cf10.png](:/fd1bbba8ded740d2bc16b5137580e2db)

**15.3. Yandex Cloud**

![67ca045b86f3bdf268e75ff6c10ddd2d.png](:/e8f8de00a1b44b73a9dc767ef77ecb50)

**Итог:**

![616e273a2f9bd793ba433a760ff3e52f.png](:/506bf3bd184947678cf0530b48c28e4b)

### 16. Пробую выполнить Ansible Playbook

**16.1. И сразу же получаю исключение:**

![8e778846f9a12a2a89b09be8a8d5fe6c.png](:/0274641a7c4f40b3854d9bcb44f90b4a)

**Нашел скрипт на GitHub, который должен был помочь, но тщетно:**

![9869c31fbe4f1df2598fe505fae57117.png](:/2c58178105b34b288d02c9b047f6b276)

**16.2. Открываю соседнюю вкладку в Терминале, после этого playbook запускается (магия, не иначе)**

![b9fc8b1a58d1c5a7d1706752e9481b84.png](:/a79e5ea293e143c9a464597604af29c8)

**\*Далее идет большой вывод\***

**16.3. Все отработало успешно, кроме yandexcloud-ansible**

![b408cfd314985d1dbe176f45db3443f8.png](:/5a4822a7f0e2476e8c1bba2b37ded29e)

**Ошибка:** ругается на отсутствие файла */etc/postgresql/15/main/postgresql.conf*

![7d2476e1d325082f2b5d843e1efc44a0.png](:/f502c2a8fee34d3886ad721b4123e1cd)

Вижу, что кластер не запущен, и каталога */etc/postgresql/15* нет, а при попытке запустить его руками выдается ошибка локали:

![fb4b6a65d6c420310bdc4f62c6045fd7.png](:/0a18a051bfd7493baa40ce74cc4da575)

**Решение, к сожалению, найти не удалось**

### 17. Выполняю попытки подключиться

Т.к. я ничего не задавал в *pg_hba.conf*, Postgres выдает мне соответствующие ошибки

![59a6027d2d5b14d0af430af661a83ce2.png](:/e14d3e6f81094f8482dda588a29d74cc)

Но если зайти на серверы и попробовать подключиться:

**17.1. Sber Cloud**

![c9480c1ee4daff417452f559e1fc5380.png](:/6fb0d542df7f4aa6a7867f57f72381b7)

**17.2. VK Cloud**

![4e89a2896f0c23b0450cbe84e7a814b7.png](:/688507fb414d402f88ab04678802bd50)

То все работает

***

**Спасибо за внимание, на сегодня**

![изображение](https://github.com/rus-99-pk/otus_edu/assets/93255418/a78e5138-f364-4321-96bf-0ba2d27e3279)
