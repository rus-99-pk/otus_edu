#  Углубленное изучение бэкапов и репликации
## Создание реплики БД
### 1\. Создал ВМ *otus-db-pg-vm-5-1* (master) и *otus-db-pg-vm-5-2* (replica) с Ubuntu 20.04 в ЯО
![6fcb2967bf2e9ce12212e19c1f0ff5cf.png](:/eeeefa6aa61e466c86f8863d9517dc6a)

### 2\. Установил Postgres 15 по [документации](https://www.postgresql.org/download/linux/ubuntu/)

### 3\. Убедился, что Postgres запущен и ВМ видят друг друга
	3.1. Проверил что Postgres работает и psql доступен
	3.2. Узнал имя текущего хоста
	3.3. Проверил доступность соседа
![5dee775c31195bbcc648e4305fe1b952.png](:/c8d32d69abf34cf4a9f75e2864131a09)
**Поправка:*** Понял, что **postgresql.auto.conf** не лучшая идея, и создал конфигурацию в **conf.d** (+ внес некоторые изменения по производительности с помощью [pgtune](https://pgtune.leopard.in.ua/))
![ad6a57bcb0364f73d8c7f4bb48413d0c.png](:/0fe24bad89124ce780be1808b36caa48)
### 4\. Добавляю в pg_hba и в postgresql.auto.conf параметры для беспрепятственного подключения
![d5bf0ff4ff7d4967dfc0550f9c35fb15.png](:/4abbade0d06141d7947f0612719cd94c)
### 5\. Создаю на мастере тестовую таблицу и заполняю ее данными
	5.1. Создаю пользователя (replicator) для репликации
	5.2. Создаю пользователя (test_user) для подключения к тестовой БД
	5.3. Создаю тестовую БД (test_database)
	5.4. Создаю таблицу (test_table)
	5.5. Заполняю ее значениями
	5.6. Проверяю наличие данных в таблице
![c797f8e22ea1c4186e379cf57c33e227.png](:/06fe6c1fd1274bc9bfec34296d6acb1a)
### 6\. Создаю реплику и проверяю параметры подключения к мастеру
![d4bd182b4c20206259778b2948944c6b.png](:/a7ab471bf6f842bd8724fad1d651b7bc)
![a8b4da80e60fa970361cd1411ee4f239.png](:/e16ecc24f7804a70bbf17f56abae8183)
### 7\. Проверяю корректность настройки и провожу тесты репликации
	7.1. Пытаюсь запустить кластер, но Postgres не поднимается, т.к. необходимо дать полный доступ только для пользователя postgres
	7.2. Выдал необходимые права
	7.3. Пытаюсь повторить п 7.1, на этот раз ошибок нет
	7.4. Удостоверяюсь, что кластер запущен. Также замечаю, что в столбце Status появилась запись recovery
	7.5. Проверяю статус репликации на мастере, вроде бы все даже хорошо, но выполню еще пару проверок (на всякий случай)
	7.6. Добавляю еще одну запись с мастера
	7.7. УРА! На реплике запись есть, все классно
![3504a91024ed0e4d104424443cedd563.png](:/2ddabc2b2acf4e5f8d42d7e0f04cc4f3)
![de7f362a69d3d8f4e3e93d11e3eb4e52.png](:/bf3cdb97781e46829a29b2974273210f)
### 8\. Конфигурация слота репликации
	8.1. Добавляю на мастер ограничение размера слота репликации (чтобы Postgres в случае отставания реплики не съедал весь диск)
	8.2. Создаю слот otus_test_slot
	8.3. Задаю реплике название слота репликации
	8.4. Проверяю активность слота. Все в порядке :)
![3382c0169ac735c409b217293ed2e19f.png](:/68a4ebe9c21348a0937f0ad9971755ee)
## Настройка бэкапирования посредством WAL-G
### 9. Выполняю на мастере установку WAL-G
	9.1. Выполняю команду скачивания и распаковки утилиты
	9.2. Проверяю наличие ПО
	9.3. Создаю каталог для хранения бэкапов
![2db0f558924f67fd645199c9e4336682.png](:/0e5f89ebda334f32893cdfc53670d370)
### 10. Конфигурирую WAL-G
	10.1. Создал конфиг, задал необходимые параметры
	10.2. Создал каталог для хранения логов архивирования/восстановления
	10.3. Задаю режим (Postgres) и команды (WAL-G) архивирования
	10.4. Перезапускаю кластер
	10.5. Проверяю статус архивирования
	10.6. Понимаю, что WAL-G не знает что такое ~postgres и меняю на абсолютный путь в конфиге (п. 10.1.)
	10.7. Вижу, что после изменения в п. 10.6. все стало ОК
	10.8. Убеждаюсь, что WAL'ы архивируются успешно
![986b49fe291d6a5f63fb745fbe8d961e.png](:/e23500ae80164929bd244090dd489a8b)
### 11. Выполняю тестовый бэкап
Кажется, выполнился успешно
![ead199912e9ee3e32a9fff61f1c81854.png](:/7166a7105f1a4702beaf1c819b37d448)
### 12. Пробую восстановиться из последнего бэкапа
	12.1. Добавляю еще одно значение в таблицу
	12.2. Выполняю еще один бэкап
	12.3. Убеждаюсь, что значение есть
	12.4. Останавливаю кластер
	12.5. Вместо удаления, с запасом переношу каталог с данными
	12.6. Зачищаю старый каталог с данными
	12.7. Восстанавливаюсь из свежего бэкапа
	12.8. Пробую запустить кластер
	12.9. Удивляюсь, что он не запустился, и кажется понимаю почему
	12.10. Создаю файл сигнала
	12.11. Пробую запустить кластер еще раз, на этот раз удачно
	12.12. Проверяю наличие данных, и все круто
![ecc13c37c05b2bf974f817e2de9e8649.png](:/48fdf2683f824de2b91ff2bcc7942ec0)
![ebf33ba666f998ea23cc987d799e0fc2.png](:/1b2e687f2ed245708d1aa6407898de67)
