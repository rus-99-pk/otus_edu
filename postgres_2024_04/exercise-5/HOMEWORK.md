#  Углубленное изучение бэкапов и репликации
## Создание реплики БД
### 1\. Создал ВМ *otus-db-pg-vm-5-1* (master) и *otus-db-pg-vm-5-2* (replica) с Ubuntu 20.04 в ЯО
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/963a6fcd-96a2-4828-bcb2-3a54aff7af54)

### 2\. Установил Postgres 15 по [документации](https://www.postgresql.org/download/linux/ubuntu/)

### 3\. Убедился, что Postgres запущен и ВМ видят друг друга
	3.1. Проверил что Postgres работает и psql доступен
	3.2. Узнал имя текущего хоста
	3.3. Проверил доступность соседа
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/928a5006-0645-4b05-865a-f76c96c8c48c)

**Поправка:*** Понял, что **postgresql.auto.conf** не лучшая идея, и создал конфигурацию в **conf.d** (+ внес некоторые изменения по производительности с помощью [pgtune](https://pgtune.leopard.in.ua/))
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/aa430672-f5bc-4bd0-9e27-1825999ec4a8)

### 4\. Добавляю в pg_hba и в postgresql.auto.conf параметры для беспрепятственного подключения
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/caf02a46-7062-4abb-a903-c098302fd13a)

### 5\. Создаю на мастере тестовую таблицу и заполняю ее данными
	5.1. Создаю пользователя (replicator) для репликации
	5.2. Создаю пользователя (test_user) для подключения к тестовой БД
	5.3. Создаю тестовую БД (test_database)
	5.4. Создаю таблицу (test_table)
	5.5. Заполняю ее значениями
	5.6. Проверяю наличие данных в таблице
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/5bb00628-33a7-4fe3-8eba-ffa73469bb35)

### 6\. Создаю реплику и проверяю параметры подключения к мастеру
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/7df8395a-52ec-4d50-a466-a7e6c69bfadf)
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/69bdf8ac-b0a8-4109-82d9-25ffa1fe31f2)

### 7\. Проверяю корректность настройки и провожу тесты репликации
	7.1. Пытаюсь запустить кластер, но Postgres не поднимается, т.к. необходимо дать полный доступ только для пользователя postgres
	7.2. Выдал необходимые права
	7.3. Пытаюсь повторить п 7.1, на этот раз ошибок нет
	7.4. Удостоверяюсь, что кластер запущен. Также замечаю, что в столбце Status появилась запись recovery
	7.5. Проверяю статус репликации на мастере, вроде бы все даже хорошо, но выполню еще пару проверок (на всякий случай)
	7.6. Добавляю еще одну запись с мастера
	7.7. УРА! На реплике запись есть, все классно
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/86da7bfb-cd5d-41d1-acdf-566e2f00003c)
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/0a333d3d-d703-4907-93a0-94a7cc6e74bf)

### 8\. Конфигурация слота репликации
	8.1. Добавляю на мастер ограничение размера слота репликации (чтобы Postgres в случае отставания реплики не съедал весь диск)
	8.2. Создаю слот otus_test_slot
	8.3. Задаю реплике название слота репликации
	8.4. Проверяю активность слота. Все в порядке :)
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/b6a2a540-7150-480e-af90-d81ed5d58140)

## Настройка бэкапирования посредством WAL-G
### 9. Выполняю на мастере установку WAL-G
	9.1. Выполняю команду скачивания и распаковки утилиты
	9.2. Проверяю наличие ПО
	9.3. Создаю каталог для хранения бэкапов
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/82d16d93-2876-43d6-9018-4f73b31bb0a1)

### 10. Конфигурирую WAL-G
	10.1. Создал конфиг, задал необходимые параметры
	10.2. Создал каталог для хранения логов архивирования/восстановления
	10.3. Задаю режим (Postgres) и команды (WAL-G) архивирования
	10.4. Перезапускаю кластер
	10.5. Проверяю статус архивирования
	10.6. Понимаю, что WAL-G не знает что такое ~postgres и меняю на абсолютный путь в конфиге (п. 10.1.)
	10.7. Вижу, что после изменения в п. 10.6. все стало ОК
	10.8. Убеждаюсь, что WAL'ы архивируются успешно
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/7f06118a-2e51-4f45-ae36-8db0899db844)

### 11. Выполняю тестовый бэкап
Кажется, выполнился успешно
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/5fb6dac6-8cae-46d2-a59c-f74124faeb81)

### 12. Пробую восстановиться из последнего бэкапа
	12.1. Добавляю еще одно значение в таблицу
	12.2. Выполняю еще один бэкап
	12.3. Убеждаюсь, что значение есть
	12.4. Останавливаю кластер
	12.5. Вместо удаления, с запасом переношу каталог с данными
	12.6. Зачищаю старый каталог с данными
	12.7. Восстанавливаюсь из свежего бэкапа
	12.8. Пробую запустить кластер
	12.9. Удивляюсь, что он не запустился, и кажется понимаю почему
	12.10. Создаю файл сигнала
	12.11. Пробую запустить кластер еще раз, на этот раз удачно
	12.12. Проверяю наличие данных, и все круто
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/3b4cc7ff-289f-4363-8326-971f71db2ffb)
![image](https://github.com/rus-99-pk/otus_edu/assets/93255418/f36b14ef-0dbd-456a-8f8d-3273e8856907)

