# PostgreSQL и Яндекс Облако 2

### 1. Открываю консоль ЯО

![147bdeeeb7e3dbec3fc8314e16f3e719.png](:/33a035ee3be24a3aa783c59f7049e8e1)

### 2. Создаю Managed Service for PostgreSQL

> Нажимаю на `Managed Service for PostgreSQL`

> Нажимаю `Создать кластер`

### 2.1. Задаю необходимые параметры

* * *
**Базовые параметры**
* * *

**2.1.1. Имя кластера**

> otus-pg-ex-22

**2.1.2. Окружение**

> PRESTABLE

**2.1.3. Версия**

> 16

**2.1.4. Тип**

> cpu-optimized (2 cores, 4 ГБ ОЗУ)

**2.1.5. Размер хранилища**

> network-ssd, 30 ГБ

* * *
**База данных**
* * *

**2.1.6. Имя БД, Имя пользователя, Пароль**

> otus-pg-ex-22

**2.1.7. Локаль сортировки, Локаль набора символов**

> ru_RU.UTF-8

* * *
**Сетевые настройки**
* * *

> Нажимаю `Создать сеть`

**2.1.8. Создание сети**

> otus-pg-ex-22-net

> - [x] Создать подсети

**2.1.9. Группы безопасности**

> Кликаю на `—` > `Добавить группу безопасности`

**2.1.10. Создание группы безопасности**

> Имя: otus-pg-ex-22-secgroup

> Иду в `Virtual Private Cloud` > `Группы безопасности` > `otus-pg-ex-22-secgroup` > `Редактировать` > `Правила (Входящий трафик)` > `Добавить правило`

**2.1.11. Добавление правила для входящего трафика**

**2.1.11.1. Описание**

> Allow IN from my IP

**2.1.11.2. Источник**

> CIDR

**2.1.11.3. CIDR блоки**

> Выполняю в терминале `curl icanhazip.com`

> xx.xx.xxx.0/24

> Нажимаю `Сохранить`

**2.1.12. Добавление правила для исходящего трафика**

**2.1.12.1. Описание**

> Allow OUT

**2.1.12.2. Источник**

> CIDR

**2.1.12.3. CIDR блоки**

> Выполняю в терминале `curl icanhazip.com`

> 0.0.0.0/0

> Нажимаю `Сохранить`

> Возвращаюсь снова на страницу создания кластера

**2.1.13. Группы безопасности**

> Кликаю на `otus-pg-ex-22-secgroup`

**2.1.14. Кликаю `Создать кластер`**

> Дожидаюсь, пока кластер не будет в состоянии `Alive`

![624dad8a639c675ce732dfccd42986f3.png](:/dbb4053a89204b418ba28e8add32acab)

### 3. Выполняю подключение

### 3.1. Нажимаю на `...` > `Подключиться`

### 3.2. Устанавливаю сертификат

![2c5c1d31dc1add02db90977f4d61b709.png](:/ee10bafc6c9f46afbfa86c5d3f59f83e)

> Т.к. `psql` у меня уже установлен, пропускаю шаг с его установкой

### 3.3. Пробую подключиться

> Но при попытке подключиться доменные имена по какой-то причине не разрешаются

![6a376f99a9dce734951d1f250edf5334.png](:/23144e9764bf47e3a371c47af7d19df6)

> Чуть позже понимаю публичный доступ отсутствует

![06051b4e1e121700921e10297ca03e29.png](:/f83e5b2c787a488b98f15ae47c441d11)

 **3.3.1. Нажимаю `...` обоих хостов > и выставляю `Публичный доступ [x]`**
 
 > Сейчас вроде бы в порядке

![dd9b9e5de859831574d236444650d003.png](:/794ce39e2a4640eaa941c1aada56e4d4)

**3.3.2. Пробую подключиться на мастер**

![aa7eadab22266d3232b3c1cb2a1e6600.png](:/ce82a61a2a684fd2ac2c13c0bdb8d2c1)

> Успешно

**3.3.3. Пытаюсь создать таблицу**

![3eda34fc3eae4c2c2b48ec7c30ebba03.png](:/7bf20f3c4e2a43439de1ed69ae8f46d4)

> Здесь тоже удачно

**3.3.4. Попробую подключиться на реплику и удалить таблицу**

**3.3.4.1. Выполняю подключение на FQDN реплики**

**3.3.4.2. Postgres не разрешает подключиться**

**3.3.4.3. Удаляю `target_session_attrs` и пробую еще раз, на этот раз удачно**

**3.3.4.4. Пробую удалить таблицу, но это не заканчивается успехом, отлично** 

![0cdcc1773169b2b4c1beda060063f819.png](:/8f0ce6db2fd245d2b242d17343a9e1a7)

### 3.4. Пробую теперь подключиться с другого IP

**3.4.1. Подключаю VPN**

![8a4efaf001128763304843919f6ca7cb.png](:/cde1d065932348a8be94d9f8ee8db02c)

**3.4.2. Пробую подключиться**

> И... файерволл работает

![e850d9ef7d84fd42a59ce0c35f4d34b7.png](:/28e929056a4a47d691de0cc69a2562fc)
